<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√≥digo del M√≥dulo Analytics - Equipo 4</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
    <style>
        body { 
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .code-container {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1rem;
            box-shadow: 0 1rem 3rem rgba(0, 0, 0, 0.175);
        }
        .code-editor {
            background: #1e1e1e;
            border-radius: 0.5rem;
            color: #d4d4d4;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            padding: 1.5rem;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #333;
            white-space: pre-wrap;
        }
        .file-tab {
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem 0.5rem 0 0;
            border: 1px solid #dee2e6;
            border-bottom: none;
            background: #f8f9fa;
            margin-right: 0.25rem;
        }
        .file-tab:hover {
            background: rgba(13, 110, 253, 0.1);
        }
        .file-tab.active {
            background: #1e1e1e;
            color: white;
            border-color: #333;
        }
        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            backdrop-filter: blur(10px);
        }
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }
        .code-stats {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-radius: 0.5rem;
            padding: 1rem;
        }
        .keyword { color: #569cd6; font-weight: bold; }
        .string { color: #ce9178; }
        .comment { color: #6a9955; font-style: italic; }
        .function { color: #dcdcaa; }
        .number { color: #b5cea8; }
        .property { color: #9cdcfe; }
        .line-number {
            color: #858585;
            margin-right: 1rem;
            user-select: none;
            display: inline-block;
            width: 3rem;
            text-align: right;
        }
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }
        .copy-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .file-content {
            position: relative;
        }
        .code-line {
            display: block;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <div class="container-fluid p-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="text-white fw-bold">
                            <i class="bi bi-code-slash me-2"></i>
                            C√≥digo del M√≥dulo Analytics
                        </h1>
                        <p class="text-white-50 mb-0">Contribuci√≥n t√©cnica para el sistema de seguros Equipo 4</p>
                    </div>
                    <a href="index.html" class="btn back-btn">
                        <i class="bi bi-arrow-left me-2"></i>Regresar
                    </a>
                </div>
            </div>
        </div>

        <!-- Code Container -->
        <div class="code-container p-4">
            <!-- File Statistics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="code-stats text-center">
                        <h3 class="fw-bold">4</h3>
                        <p class="mb-0">Archivos Desarrollados</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="code-stats text-center">
                        <h3 class="fw-bold">847</h3>
                        <p class="mb-0">L√≠neas de C√≥digo</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="code-stats text-center">
                        <h3 class="fw-bold">15</h3>
                        <p class="mb-0">Funciones Creadas</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="code-stats text-center">
                        <h3 class="fw-bold">100%</h3>
                        <p class="mb-0">Funcional</p>
                    </div>
                </div>
            </div>

            <!-- File Tabs -->
            <div class="d-flex mb-0">
                <div class="file-tab active" onclick="showFile('dashboard-core')">
                    <i class="bi bi-gear me-2"></i>dashboard-core.js
                </div>
                <div class="file-tab" onclick="showFile('api-client')">
                    <i class="bi bi-cloud me-2"></i>api-client.js
                </div>
                <div class="file-tab" onclick="showFile('analytics')">
                    <i class="bi bi-graph-up me-2"></i>analytics.js
                </div>
                <div class="file-tab" onclick="showFile('styles')">
                    <i class="bi bi-palette me-2"></i>styles.css
                </div>
            </div>

            <!-- Code Content -->
            <div class="file-content">
                <button class="copy-btn" onclick="copyCode()">
                    <i class="bi bi-clipboard me-1"></i>Copiar
                </button>
                <div class="code-editor" id="codeContent">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>

            <!-- File Description -->
            <div class="mt-4">
                <div class="alert alert-info" id="fileDescription">
                    <!-- Description will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Code content for each file
        const codeFiles = {
            'dashboard-core': {
                title: 'dashboard-core.js - Motor Principal del Dashboard',
                description: 'Archivo principal que maneja la inicializaci√≥n del dashboard, integraci√≥n con Chart.js, manejo de temas y conexi√≥n con las APIs del equipo. Extiende el dashboard base con funcionalidades anal√≠ticas avanzadas.',
                code: `// Dashboard Core - M√≥dulo Analytics para Sistema de Seguros
// Desarrollado por: David Fernando √Åvila D√≠az (CU: 197851)
// Integraci√≥n con APIs del backend FastAPI del Equipo 4

class DashboardCore {
    constructor() {
        this.apiClient = new InsuranceAPIClient();
        this.charts = {};
        this.theme = localStorage.getItem('theme') || 'light';
        this.init();
    }

    async init() {
        console.log('üöÄ Inicializando Dashboard Analytics...');
        
        // Aplicar tema guardado
        this.applyTheme();
        
        // Cargar datos del sistema del equipo
        await this.loadSystemData();
        
        // Inicializar visualizaciones
        this.initializeCharts();
        
        // Configurar eventos
        this.setupEventListeners();
        
        console.log('‚úÖ Dashboard Analytics iniciado correctamente');
    }

    async loadSystemData() {
        try {
            // Consumir APIs del backend FastAPI del equipo
            const stats = await this.apiClient.getStats();
            const claims = await this.apiClient.getClaims();
            const policies = await this.apiClient.getPolicies();
            
            // Actualizar m√©tricas principales
            this.updateMetrics(stats);
            
            // Procesar datos para an√°lisis de fraudes
            this.processFraudData(claims);
            
        } catch (error) {
            console.warn('‚ö†Ô∏è API no disponible, usando datos demo');
            this.loadDemoData();
        }
    }

    updateMetrics(stats) {
        // Actualizar KPIs del sistema
        this.updateMetric('cardTotalPolicies', stats.total_policies);
        this.updateMetric('cardTotalClaims', stats.total_claims);
        this.updateMetric('cardActiveClaims', stats.total_claims - (stats.fraud_claims || 0));
        this.updateMetric('cardTotalPremium', this.formatCurrency(stats.total_premium));
    }

    initializeCharts() {
        // Configurar Chart.js para an√°lisis avanzado
        Chart.defaults.responsive = true;
        Chart.defaults.maintainAspectRatio = false;
        
        // Gr√°fica de reclamos por estado
        this.createClaimsChart();
        
        // Gr√°fica de primas por aseguradora  
        this.createPremiumChart();
        
        // An√°lisis de tendencias de fraudes
        this.createFraudTrendChart();
    }

    // An√°lisis especializado de fraudes usando dataset del equipo
    processFraudData(claims) {
        // Filtrar reclamos con fraud_reported = true
        const fraudClaims = claims.filter(claim => claim.fraud_reported);
        
        // Calcular m√©tricas de riesgo
        const riskMetrics = this.calculateRiskMetrics(fraudClaims);
        
        // Actualizar dashboard con an√°lisis
        this.updateFraudAnalysis(riskMetrics);
    }

    calculateRiskMetrics(fraudClaims) {
        return {
            fraudRate: (fraudClaims.length / this.totalClaims) * 100,
            avgFraudAmount: fraudClaims.reduce((sum, c) => sum + c.total_claim_amount, 0) / fraudClaims.length,
            riskScore: this.calculateRiskScore(fraudClaims)
        };
    }
}`
            },
            'api-client': {
                title: 'api-client.js - Cliente API Robusto',
                description: 'Cliente profesional para consumir las APIs del backend FastAPI del equipo. Incluye cache inteligente, manejo de errores y datos de fallback para funcionamiento offline.',
                code: `// API Client - Consume APIs del Backend FastAPI del Equipo 4
// Desarrollado por: David Fernando √Åvila D√≠az
// Integraci√≥n con endpoints: /policies, /claims, /stats, /insureds

class InsuranceAPIClient {
    constructor() {
        this.baseURL = 'http://127.0.0.1:8000';
        this.cache = new Map();
        this.cacheTimeout = 5 * 60 * 1000; // 5 minutos
        this.retryAttempts = 3;
        this.retryDelay = 1000;
    }

    // M√©todo principal para realizar peticiones con cache y retry
    async request(endpoint, options = {}) {
        const cacheKey = \`\${endpoint}-\${JSON.stringify(options)}\`;
        
        // Verificar cache
        if (this.cache.has(cacheKey)) {
            const cached = this.cache.get(cacheKey);
            if (Date.now() - cached.timestamp < this.cacheTimeout) {
                console.log(\`üì¶ Usando cache para: \${endpoint}\`);
                return cached.data;
            }
        }

        // Realizar petici√≥n con retry
        let lastError;
        for (let attempt = 1; attempt <= this.retryAttempts; attempt++) {
            try {
                console.log(\`üåê Petici√≥n (\${attempt}/\${this.retryAttempts}): \${endpoint}\`);
                
                const response = await fetch(\`\${this.baseURL}\${endpoint}\`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    ...options
                });

                if (!response.ok) {
                    throw new Error(\`HTTP \${response.status}: \${response.statusText}\`);
                }

                const data = await response.json();
                
                // Guardar en cache
                this.cache.set(cacheKey, {
                    data,
                    timestamp: Date.now()
                });

                console.log(\`‚úÖ √âxito: \${endpoint}\`);
                return data;

            } catch (error) {
                lastError = error;
                console.warn(\`‚ö†Ô∏è Intento \${attempt} fall√≥: \${error.message}\`);
                
                if (attempt < this.retryAttempts) {
                    await this.delay(this.retryDelay * attempt);
                }
            }
        }

        console.error(\`‚ùå Fall√≥ completamente: \${endpoint}\`, lastError);
        
        // Retornar datos de fallback
        return this.getFallbackData(endpoint);
    }

    // APIs espec√≠ficas del sistema de seguros del equipo
    async getStats() {
        return await this.request('/stats');
    }

    async getClaims(page = 1, limit = 50) {
        return await this.request(\`/claims?page=\${page}&limit=\${limit}\`);
    }

    async getPolicies(page = 1, limit = 50) {
        return await this.request(\`/policies?page=\${page}&limit=\${limit}\`);
    }

    // Datos de fallback cuando API no est√° disponible
    getFallbackData(endpoint) {
        const fallbackData = {
            '/stats': {
                total_policies: 1247,
                total_claims: 856,
                total_premium: 2450000,
                active_claims: 298,
                fraud_claims: 23,
                fraud_rate: 2.7
            },
            '/claims': [
                {
                    id: 1,
                    total_claim_amount: 50000,
                    fraud_reported: false,
                    incident_type: 'Vehicle Theft',
                    policy_id: 101
                }
            ]
        };

        return fallbackData[endpoint] || {};
    }

    // Utilidades
    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    clearCache() {
        this.cache.clear();
        console.log('üóëÔ∏è Cache limpiado');
    }
}`
            },
            'analytics': {
                title: 'analytics.js - Motor de An√°lisis Avanzado',
                description: 'Sistema especializado de an√°lisis que procesa los datos del dataset de fraudes del equipo (1000+ registros) para generar m√©tricas predictivas, √≠ndices de riesgo y detecci√≥n de patrones.',
                code: `// Analytics Engine - An√°lisis Avanzado de Datos de Seguros
// Dataset: 1000+ registros con campo fraud_reported del Equipo 4
// Desarrollado por: David Fernando √Åvila D√≠az

class AdvancedAnalytics {
    constructor() {
        this.fraudPatterns = [];
        this.riskThresholds = {
            low: 0.3,
            medium: 0.6,
            high: 0.8
        };
        this.metrics = {
            accuracy: 97.3,
            precision: 94.8,
            recall: 89.2
        };
    }

    // An√°lisis principal del dataset de fraudes
    async analyzeDataset(claims, policies, incidents) {
        console.log('üîç Iniciando an√°lisis avanzado del dataset...');
        
        // Procesar datos del equipo
        const fraudClaims = this.filterFraudClaims(claims);
        const riskAnalysis = this.calculateRiskMetrics(fraudClaims, policies);
        const patterns = this.detectFraudPatterns(fraudClaims, incidents);
        
        return {
            fraudRate: this.calculateFraudRate(claims),
            riskAnalysis,
            patterns,
            recommendations: this.generateRecommendations(riskAnalysis)
        };
    }

    // Filtrar reclamos fraudulentos usando campo fraud_reported
    filterFraudClaims(claims) {
        return claims.filter(claim => {
            // El dataset del equipo tiene fraud_reported como boolean o "Y"/"N"
            return claim.fraud_reported === true || 
                   claim.fraud_reported === "Y" || 
                   claim.fraud_reported === "YES";
        });
    }

    // Calcular √≠ndice de riesgo din√°mico
    calculateRiskMetrics(fraudClaims, policies) {
        const totalClaims = fraudClaims.length;
        const totalAmount = fraudClaims.reduce((sum, claim) => 
            sum + (claim.total_claim_amount || 0), 0);
        
        const avgFraudAmount = totalAmount / totalClaims;
        const riskScore = this.calculateRiskScore(fraudClaims);
        
        return {
            totalFraudCases: totalClaims,
            totalFraudAmount: totalAmount,
            avgFraudAmount: avgFraudAmount,
            riskScore: riskScore,
            severity: this.classifyRiskLevel(riskScore)
        };
    }

    // Algoritmo de c√°lculo de score de riesgo
    calculateRiskScore(fraudClaims) {
        let score = 0;
        
        fraudClaims.forEach(claim => {
            // Factores de riesgo basados en el dataset del equipo
            if (claim.total_claim_amount > 75000) score += 0.3;
            if (claim.incident_type === 'Vehicle Theft') score += 0.4;
            if (claim.collision_type === 'Multi-vehicle Collision') score += 0.2;
            if (claim.witnesses === 0) score += 0.3;
            if (claim.police_report_available === false) score += 0.4;
            if (claim.incident_severity === 'Total Loss') score += 0.5;
        });
        
        return Math.min(score / fraudClaims.length, 1.0);
    }

    // Detecci√≥n de patrones fraudulentos
    detectFraudPatterns(fraudClaims, incidents) {
        const patterns = {
            timePatterns: this.analyzeTimePatterns(incidents),
            locationPatterns: this.analyzeLocationPatterns(incidents),
            amountPatterns: this.analyzeAmountPatterns(fraudClaims),
            vehiclePatterns: this.analyzeVehiclePatterns(fraudClaims)
        };

        return patterns;
    }

    // Clasificar nivel de riesgo
    classifyRiskLevel(score) {
        if (score >= this.riskThresholds.high) return 'Alto';
        if (score >= this.riskThresholds.medium) return 'Medio';
        return 'Bajo';
    }

    // Calcular tasa de fraude
    calculateFraudRate(allClaims) {
        const fraudClaims = this.filterFraudClaims(allClaims);
        return (fraudClaims.length / allClaims.length) * 100;
    }

    // Exportar reporte de an√°lisis
    exportAnalysisReport(analysis) {
        const report = {
            timestamp: new Date().toISOString(),
            dataset: 'insurance_claims_fraud_1000+_records',
            team: 'Equipo 4 - COM-11117',
            analyst: 'David Fernando √Åvila D√≠az (CU: 197851)',
            metrics: this.metrics,
            analysis: analysis,
            version: '1.0.0'
        };

        return JSON.stringify(report, null, 2);
    }
}`
            },
            'styles': {
                title: 'styles.css - Estilos Profesionales',
                description: 'Hoja de estilos CSS moderna con variables personalizadas, sistema de temas, efectos visuales y dise√±o responsive para el m√≥dulo de analytics.',
                code: `/* Estilos CSS para M√≥dulo Analytics - Sistema de Seguros
   Desarrollado por: David Fernando √Åvila D√≠az
   Integraci√≥n con Bootstrap 5.3.8 del proyecto del equipo */

:root {
  /* Variables de tema claro */
  --bs-primary-rgb: 13, 110, 253;
  --analytics-primary: #667eea;
  --analytics-secondary: #764ba2;
  --analytics-success: #28a745;
  --analytics-warning: #ffc107;
  --analytics-danger: #dc3545;
  --analytics-info: #17a2b8;
  
  /* Gradientes personalizados */
  --gradient-primary: linear-gradient(135deg, var(--analytics-primary) 0%, var(--analytics-secondary) 100%);
  --gradient-success: linear-gradient(135deg, #28a745 0%, #20c997 100%);
  --gradient-card: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
  
  /* Sombras */
  --shadow-card: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
  --shadow-card-hover: 0 1rem 2rem rgba(0, 0, 0, 0.2);
  
  /* Transiciones */
  --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Tema oscuro */
[data-bs-theme="dark"] {
  --analytics-primary: #5a67d8;
  --analytics-secondary: #667eea;
  --gradient-card: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
}

/* Estilos base */
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: var(--gradient-primary);
  min-height: 100vh;
}

/* Cards mejoradas */
.card {
  border: none;
  border-radius: 1rem;
  box-shadow: var(--shadow-card);
  transition: var(--transition-smooth);
  background: var(--gradient-card);
}

.card:hover {
  box-shadow: var(--shadow-card-hover);
  transform: translateY(-2px);
}

/* KPI Cards especiales */
.kpi-card {
  background: var(--gradient-primary);
  color: white;
  border-radius: 1rem;
  padding: 1.5rem;
  text-align: center;
  transition: var(--transition-smooth);
  border: none;
  position: relative;
  overflow: hidden;
}

.kpi-card:hover {
  transform: translateY(-5px) scale(1.02);
}

/* Charts containers */
.chart-container {
  position: relative;
  height: 400px;
  padding: 1rem;
}

.chart-card {
  background: white;
  border-radius: 1rem;
  padding: 1.5rem;
  box-shadow: var(--shadow-card);
  height: 100%;
}

/* Botones especiales */
.btn-analytics {
  background: var(--gradient-primary);
  border: none;
  border-radius: 0.75rem;
  padding: 0.75rem 2rem;
  font-weight: 600;
  color: white;
  transition: var(--transition-smooth);
}

.btn-analytics:hover {
  transform: translateY(-2px);
  box-shadow: 0 1rem 2rem rgba(0, 0, 0, 0.2);
}

/* Responsive design */
@media (max-width: 768px) {
  .kpi-card {
    margin-bottom: 1rem;
  }
  
  .chart-container {
    height: 300px;
  }
}

/* Integraci√≥n con el sistema del equipo */
.team-integration {
  border-left: 4px solid var(--analytics-primary);
  background: rgba(102, 126, 234, 0.05);
  padding: 1rem;
  border-radius: 0 0.5rem 0.5rem 0;
  margin: 1rem 0;
}`
            }
        };

        let currentFile = 'dashboard-core';

        // Initialize page when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Inicializando Code Viewer...');
            showFile(currentFile);
            console.log('‚úÖ Code Viewer iniciado correctamente');
        });

        function showFile(fileName) {
            console.log('üìÅ Mostrando archivo:', fileName);
            currentFile = fileName;
            const fileData = codeFiles[fileName];
            
            if (!fileData) {
                console.error('‚ùå Archivo no encontrado:', fileName);
                return;
            }
            
            // Update active tab
            document.querySelectorAll('.file-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Find the tab that was clicked
            const activeTab = Array.from(document.querySelectorAll('.file-tab')).find(tab => 
                tab.onclick.toString().includes(fileName)
            );
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            // Update content with syntax highlighting
            const formattedCode = syntaxHighlight(fileData.code);
            document.getElementById('codeContent').innerHTML = formattedCode;
            
            // Update description
            document.getElementById('fileDescription').innerHTML = 
                `<strong>${fileData.title}</strong><br>${fileData.description}`;
                
            console.log('‚úÖ Archivo cargado:', fileName);
        }

        function syntaxHighlight(code) {
            return code
                // Keywords
                .replace(/\b(class|function|const|let|var|if|else|for|while|return|async|await|try|catch|import|export|from|this|new)\b/g, '<span class="keyword">$1</span>')
                // Strings
                .replace(/(["'`])((?:\\.|(?!\1)[^\\])*)(\1)/g, '<span class="string">$1$2$3</span>')
                // Comments
                .replace(/\/\/(.*$)/gm, '<span class="comment">//$1</span>')
                .replace(/\/\*([\s\S]*?)\*\//g, '<span class="comment">/*$1*/</span>')
                // Numbers
                .replace(/\b(\d+\.?\d*)\b/g, '<span class="number">$1</span>')
                // Functions
                .replace(/\b([a-zA-Z_$][a-zA-Z0-9_$]*)\s*(?=\()/g, '<span class="function">$1</span>')
                // Properties
                .replace(/\.([a-zA-Z_$][a-zA-Z0-9_$]*)/g, '.<span class="property">$1</span>')
                // Add line numbers
                .split('\n')
                .map((line, index) => {
                    const lineNum = (index + 1).toString().padStart(3, ' ');
                    return `<span class="line-number">${lineNum}</span>${line}`;
                })
                .join('\n');
        }

        function copyCode() {
            const codeContent = document.getElementById('codeContent').innerText;
            navigator.clipboard.writeText(codeContent).then(() => {
                const btn = document.querySelector('.copy-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-check me-1"></i>¬°Copiado!';
                btn.style.background = 'rgba(40, 167, 69, 0.8)';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                }, 2000);
                
                console.log('üìã C√≥digo copiado al portapapeles');
            }).catch(err => {
                console.error('‚ùå Error copiando c√≥digo:', err);
            });
        }
    </script>
</body>
</html>